<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NSFW 关键词超市（AI Prompt 工作台）</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <!-- 移除 CSP，允许 inline style -->
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Segoe UI', sans-serif; background:#111; color:#eee; }
    .header { padding:16px; background:#222; text-align:center; font-size:1.4em; font-weight:bold; }
    .controls { display:flex; gap:8px; padding:12px; background:#222; flex-wrap:wrap; }
    button { padding:8px 16px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer; }
    button:hover { background:#0056b3; }
    button:disabled { background:#555; cursor:not-allowed; }
    .container { display:flex; height:calc(100vh - 120px); }
    .sidebar { width:260px; background:#1a1a1a; padding:12px; overflow-y:auto; position:relative; }
    .sidebar .loading { text-align:center; color:#666; padding:20px; }
    .sidebar ul { list-style:none; }
    .sidebar li { margin:4px 0; }
    .folder { display:block; padding:8px; background:#333; border-radius:4px; cursor:pointer; }
    .folder:hover { background:#444; }
    .sub { margin-left:20px; margin-top:4px; }
    .main { flex:1; padding:12px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); gap:12px; padding:12px; }
    .card { background:#222; border-radius:8px; overflow:hidden; }
    .card img { width:100%; height:140px; object-fit:cover; }
    .card-body { padding:12px; }
    .card-title { font-weight:bold; margin-bottom:4px; }
    .card-subtitle { color:#aaa; font-size:0.9em; }
    .card-actions { display:flex; gap:8px; margin-top:8px; }
    .btn-copy, .btn-cart { flex:1; padding:6px; font-size:0.9em; }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; z-index:100; }
    .modal-content { background:#222; padding:20px; border-radius:8px; width:90%; max-width:500px; }
    .form-group { margin-bottom:12px; }
    label { display:block; margin-bottom:4px; color:#ccc; }
    input, select { width:100%; padding:8px; background:#333; border:1px solid #444; border-radius:4px; color:white; }
    .cascade-selects { display:flex; gap:8px; }
    .img-section { display:flex; gap:12px; align-items:center; }
    .img-preview { width:80px; height:80px; background:#333; border-radius:4px; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .img-actions button { padding:6px 12px; font-size:0.85em; }
    .modal-footer { display:flex; gap:8px; margin-top:16px; }
    .cart-panel { position:fixed; bottom:0; left:0; right:0; background:#1a1a1a; border-top:1px solid #333; transition:height 0.3s; }
    .cart-header { display:flex; justify-content:space-between; align-items:center; padding:12px; cursor:pointer; }
    .cart-top-actions { display:flex; gap:8px; }
    .cart-top-actions button { padding:4px 8px; font-size:0.8em; }
    .cart-mid-actions { padding:0 12px 8px; }
    .cart-body { max-height:40vh; overflow-y:auto; padding:0 12px; display:none; }
    .cart-item { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid #333; }
    .remove { cursor:pointer; color:#f66; }
    .cart-actions { display:flex; gap:8px; padding:12px; display:none; }
    .toast { position:fixed; right:20px; bottom:20px; background:#333; color:white; padding:12px 20px; border-radius:4px; opacity:0; transform:translateX(100%); transition:all 0.3s; z-index:1000; }
    .toast.error { background:#c33; }
    .draw-tags { max-height:200px; overflow-y:auto; margin:12px 0; }
    .draw-result { text-align:center; font-weight:bold; margin:12px 0; }
  </style>
</head>
<body>

  <div class="header">NSFW 关键词超市（AI Prompt 工作台）</div>
  <div class="controls">
    <button onclick="UI.openAddModal()">新增关键词</button>
    <button onclick="Data.export()">导出 JSON</button>
    <input type="file" id="importFile" accept=".json" onchange="Data.import(event)" style="display:none;">
    <button onclick="document.getElementById('importFile').click()">导入 JSON</button>
    <button onclick="Data.sync()" class="btn-sync">同步到云端</button>
  </div>

  <!-- 新增弹窗 -->
  <div id="addModal" class="modal">
    <div class="modal-content">
      <h3>新增 NSFW 关键词</h3>
      <div class="form-group">
        <label>目标标签路径</label>
        <div class="cascade-selects">
          <select id="level1"><option value="">一级标签</option></select>
          <select id="level2"><option value="">二级标签</option></select>
        </div>
      </div>
      <div class="form-group"><label>英文关键词</label><input type="text" id="newWord" placeholder="e.g., large breasts"></div>
      <div class="form-group"><label>中文翻译</label><input type="text" id="newZh" placeholder="e.g., 巨乳"></div>
      <div class="form-group"><label>强度 (0.1 - 1.0)</label><input type="number" id="newStrength" step="0.1" min="0.1" max="1.0" value="0.8"></div>
      <div class="form-group">
        <label>图片</label>
        <div class="img-section">
          <div class="img-preview" id="imgPreview"><small style="color:#666;">上传后显示</small></div>
          <div class="img-actions">
            <input type="file" id="imgUpload" accept="image/*" style="display:none;">
            <button class="btn-select" id="btnSelectImg">选择</button>
            <button class="btn-upload" id="btnUploadImg" disabled>上传</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="UI.closeModal('addModal')">取消</button>
        <button class="btn-confirm" onclick="Data.addKeyword()">确认添加</button>
      </div>
    </div>
  </div>

  <!-- 抽词弹窗 -->
  <div id="drawModal" class="modal">
    <div class="modal-content" style="max-width:400px;">
      <h3>随机抽词</h3>
      <div class="draw-tags" id="drawTags"></div>
      <div class="draw-result" id="drawResult">点击下方按钮开始抽词</div>
      <div class="modal-footer">
        <button class="btn-confirm" onclick="Cart.drawWord()">抽一个词</button>
        <button class="btn-cancel" onclick="UI.closeModal('drawModal')">关闭</button>
      </div>
    </div>
  </div>

  <div class="container">
    <nav class="sidebar">
      <div class="loading">云端加载中...</div>
      <ul id="navTree" style="display:none;"></ul>
    </nav>
    <section class="main">
      <div class="controls">
        <select id="sortOrder" onchange="UI.renderCards()">
          <option value="desc">复制次数降序</option>
          <option value="asc">复制次数升序</option>
        </select>
        <button onclick="Cart.clear()">清空购物车</button>
      </div>
      <div id="cardGrid" class="grid"><div class="loading">请先选择左侧分类</div></div>
    </section>
  </div>

  <!-- 购物车面板 -->
  <div id="cartPanel" class="cart-panel" style="height:50px;">
    <div class="cart-header" onclick="Cart.toggle()">
      <h3>购物车 <span id="cartCount" class="count">0</span></h3>
      <div class="cart-top-actions">
        <button onclick="event.stopPropagation(); Cart.toggleHistory()">历史</button>
        <button onclick="event.stopPropagation(); Cart.clearHistory()">清空历史</button>
        <button onclick="event.stopPropagation(); Cart.openDraw()">抽词</button>
      </div>
      <i class="fas fa-chevron-up" id="cartArrow"></i>
    </div>
    <div id="midActions" class="cart-mid-actions" style="display:none;">
      <button class="btn-save-history" onclick="Cart.saveToHistory()">加入历史</button>
    </div>
    <div id="cartBody" class="cart-body">
      <div class="cart-section"><h4>当前选词</h4><div id="cartList">购物车为空</div></div>
      <div class="cart-section" id="historySection" style="display:none;"><h4>历史记录</h4><div id="cartHistoryList"></div></div>
    </div>
    <div id="cartActions" class="cart-actions">
      <button class="btn-copy-all" onclick="Cart.copyAll()">复制全部</button>
      <button class="btn-clear" onclick="Cart.clear()">清空</button>
    </div>
  </div>

  <script>
    // ====================== 核心模块 ======================
    const BIN_ID = '690f2ed2d0ea881f40db9bc3';  // 请确认这个 ID 是否正确
    const MASTER_KEY = '$2a$10$xnT36sEdgvmYUqMghhjHuuDn.ErHF2gpSRxGohHLUJ5HUg8/Z3XEq';  // 请确认这个 Key 是否有效

    const Data = {
      local: {},
      async load() {
        console.log('Data.load() 开始，BIN_ID:', BIN_ID);
        const loadingEl = document.querySelector('.sidebar .loading');
        const navTree = document.getElementById('navTree');
        try {
          const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
            method: 'GET',
            headers: { 'X-Master-Key': MASTER_KEY },
            cache: 'no-cache'
          });
          if (!res.ok) {
            const text = await res.text();
            throw new Error(`HTTP ${res.status}: ${text}`);
          }
          const json = await res.json();
          console.log('JSONBin 返回:', json);
          const record = json.record || {};
          this.local = typeof record === 'object' && !Array.isArray(record) ? record : {};
          console.log('成功加载 this.local:', this.local);

          // 隐藏 loading
          if (loadingEl) loadingEl.style.display = 'none';
          if (navTree) navTree.style.display = 'block';

          UI.refresh();
          Toast.show('云端数据已加载');
        } catch (e) {
          console.error('加载失败:', e);
          Toast.error('加载失败: ' + e.message);
          this.local = {};
          if (loadingEl) loadingEl.textContent = '加载失败';
          UI.refresh();
        }
      },
      async sync() {
        try {
          const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-Master-Key': MASTER_KEY },
            body: JSON.stringify({ record: this.local })
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          Toast.show('已同步到云端');
        } catch (e) {
          Toast.error('同步失败: ' + e.message);
        }
      },
      export() {
        const blob = new Blob([JSON.stringify(this.local, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'nsfw-keywords.json'; a.click();
        URL.revokeObjectURL(url);
        Toast.show('已导出');
      },
      import(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          try {
            const imported = JSON.parse(ev.target.result);
            this.local = imported.record || imported;
            UI.refresh();
            Toast.show('已导入');
          } catch {
            Toast.error('JSON 格式错误');
          }
        };
        reader.readAsText(file);
      },
      addKeyword() {
        const word = document.getElementById('newWord').value.trim();
        const zh = document.getElementById('newZh').value.trim();
        const strength = parseFloat(document.getElementById('newStrength').value) || 0.8;
        const l1 = document.getElementById('level1').value;
        const l2 = document.getElementById('level2').value;
        if (!word || !l1) return Toast.error('关键词和一级标签必填');
        const path = [l1]; if (l2) path.push(l2);
        let node = this.local;
        for (let i = 0; i < path.length - 1; i++) {
          node[path[i]] = node[path[i]] || {};
          node = node[path[i]];
        }
        const target = path[path.length - 1];
        node[target] = node[target] || [];
        node[target].push({
          "词": word, "词2": zh, "强度": strength,
          "图": Cart.uploadedUrl || '', "复制": 0
        });
        UI.renderCards();
        UI.closeModal('addModal');
        Toast.show('已添加');
      }
    };

    const UI = {
      currentPath: [], currentItems: [],
      refresh() {
        const navTree = document.getElementById('navTree');
        navTree.innerHTML = '';
        if (!Data.local || Object.keys(Data.local).length === 0) {
          navTree.innerHTML = '<div style="padding:16px;color:#aaa;">暂无分类</div>';
        } else {
          DOM.buildNav(Data.local, navTree);
        }
        this.initCascade();
        this.goTo([]);
      },
      initCascade() {
        const paths = this.collectPaths();
        const l1 = document.getElementById('level1');
        const l2 = document.getElementById('level2');
        l1.innerHTML = '<option value="">一级标签</option>';
        l2.innerHTML = '<option value="">二级标签</option>';
        paths.l1.forEach(k => {
          const o = document.createElement('option');
          o.value = k; o.textContent = k; l1.appendChild(o);
        });
        l1.onchange = () => {
          const v1 = l1.value;
          l2.innerHTML = '<option value="">二级标签</option>';
          if (v1 && paths.l2[v1]) paths.l2[v1].forEach(k => {
            const o = document.createElement('option');
            o.value = k; o.textContent = k; l2.appendChild(o);
          });
        };
      },
      collectPaths() {
        const l1 = new Set(), l2 = {};
        const walk = (node, path = []) => {
          if (!node || typeof node !== 'object') return;
          if (Array.isArray(node) && path.length >= 2) {
            l1.add(path[0]); l2[path[0]] = l2[path[0]] || new Set(); l2[path[0]].add(path[1]);
          } else {
            for (const k in node) if (Object.hasOwnProperty.call(node, k)) {
              const child = node[k];
              if (child && typeof child === 'object') walk(child, [...path, k]);
            }
          }
        };
        walk(Data.local);
        return {
          l1: [...l1].sort(),
          l2: Object.fromEntries(Object.entries(l2).map(([k, v]) => [k, [...v].sort()]))
        };
      },
      goTo(path) {
        this.currentPath = path; let node = Data.local;
        for (const p of path) {
          if (!node || !(p in node)) { this.currentItems = []; this.renderCards(); return; }
          node = node[p];
        }
        this.currentItems = Array.isArray(node) ? node.map(w => typeof w === 'string' ? {词: w} : w) : [];
        this.renderCards();
      },
      renderCards() {
        const order = document.getElementById('sortOrder').value;
        const sorted = [...this.currentItems].sort((a, b) => {
          const ca = Storage.copy[a.词] || a.复制 || 0;
          const cb = Storage.copy[b.词] || b.复制 || 0;
          return order === 'desc' ? cb - ca : ca - cb;
        });
        const grid = document.getElementById('cardGrid');
        grid.innerHTML = sorted.length ? sorted.map(item => {
          const word = item.词 || item;
          const count = Storage.copy[word] || item.复制 || 0;
          const img = item.图 ? item.图.replace(/\/[^/]+$/, '/medium/$&') : '';
          return `<div class="card">
            ${img ? `<img src="${img}" loading="lazy" onerror="this.src='https://via.placeholder.com/220x140?text=无图'">` : ''}
            <div class="card-body">
              <div class="card-title">${word} ${count ? `<${count}>` : ''}</div>
              <div class="card-subtitle">${item.词2 || '无翻译'} · 强度: ${item.强度 || '-'}</div>
              <div class="card-actions">
                <button class="btn-copy" onclick="Storage.copyWord('${word}')">Copy</button>
                <button class="btn-cart" onclick="Cart.add('${word}')">Add</button>
              </div>
            </div>
          </div>`;
        }).join('') : '<div class="loading">请选择左侧分类</div>';
      },
      openAddModal() { document.getElementById('addModal').style.display = 'flex'; this.initCascade(); },
      closeModal(id) { document.getElementById(id).style.display = 'none'; }
    };

    const Cart = {
      uploadedUrl: '',
      add(word) {
        if (!Storage.cart.includes(word)) { Storage.cart.push(word); Storage.saveCart(); Cart.updateUI(); Toast.show(`已加入: ${word}`); }
        else Toast.show('已在购物车');
      },
      remove(i) { Storage.cart.splice(i, 1); Storage.saveCart(); Cart.renderList(); Cart.updateCount(); },
      clear() { Storage.cart = []; Storage.saveCart(); Cart.renderList(); Cart.updateCount(); Toast.show('购物车已清空'); },
      copyAll() {
        if (!Storage.cart.length) return Toast.show('购物车为空');
        navigator.clipboard.writeText(Storage.cart.join(', ')).then(() => { Cart.recordHistory(); Toast.show(`已复制 ${Storage.cart.length} 个`); });
      },
      recordHistory() {
        Storage.history.unshift({ time: new Date().toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }), items: [...Storage.cart] });
        if (Storage.history.length > 20) Storage.history.pop();
        Storage.saveHistory(); Cart.renderList();
      },
      saveToHistory() { if (Storage.cart.length) { Cart.recordHistory(); Toast.show('已加入历史'); } },
      clearHistory() { if (confirm('清空历史？')) { Storage.history = []; Storage.saveHistory(); Cart.renderList(); Toast.show('历史已清空'); } },
      toggle() {
        const panel = document.getElementById('cartPanel');
        const body = document.getElementById('cartBody');
        const actions = document.getElementById('cartActions');
        const mid = document.getElementById('midActions');
        const arrow = document.getElementById('cartArrow');
        const expanded = body.style.display === 'block';
        panel.style.height = expanded ? '50px' : '60vh';
        [body, actions, mid].forEach(el => el.style.display = expanded ? 'none' : 'block');
        arrow.className = expanded ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
        if (!expanded) Cart.renderList();
      },
      toggleHistory() { event.stopPropagation(); const s = document.getElementById('historySection'); s.style.display = s.style.display === 'none' ? 'block' : 'none'; },
      openDraw() { event.stopPropagation(); document.getElementById('drawModal').style.display = 'flex'; Cart.renderDrawTags(); },
      renderDrawTags() {
        const paths = [];
        for (const cat in Data.local) for (const group in Data.local[cat]) {
          if (Array.isArray(Data.local[cat][group]) && Data.local[cat][group].length) paths.push({cat, group});
        }
        const tags = document.getElementById('drawTags');
        tags.innerHTML = paths.map(p => `
          <div style="display:flex; align-items:center; padding:8px; background:#222; border-radius:6px; margin-bottom:6px;">
            <input type="checkbox" value="${p.cat}>${p.group}">
            <label style="flex:1;">${p.cat} > ${p.group} (${Data.local[p.cat][p.group].length}词)</label>
          </div>
        `).join('');
      },
      drawWord() {
        const checked = Array.from(document.querySelectorAll('#drawTags input:checked'));
        if (!checked.length) return Toast.error('请选择标签');
        const candidates = [];
        checked.forEach(cb => {
          const [cat, group] = cb.value.split('>');
          Data.local[cat][group].forEach(w => w.词 && candidates.push(w.词));
        });
        if (!candidates.length) return Toast.error('无词可抽');
        const word = candidates[Math.floor(Math.random() * candidates.length)];
        document.getElementById('drawResult').innerHTML = `${word}`;
        Cart.add(word);
      },
      updateCount() { document.getElementById('cartCount').textContent = Storage.cart.length; },
      renderList() {
        const list = document.getElementById('cartList');
        const hist = document.getElementById('cartHistoryList');
        const sec = document.getElementById('historySection');
        list.innerHTML = Storage.cart.length ? Storage.cart.map((w, i) => {
          const item = Cart.findItem(w);
          return `<div class="cart-item"><div class="word">${w}</div><div class="zh">${item?.词2 || '无'}</div><span class="remove" onclick="Cart.remove(${i})">x</span></div>`;
        }).join('') : '<div style="text-align:center;color:#666;padding:20px;">购物车为空</div>';
        sec.style.display = Storage.history.length ? 'block' : 'none';
        hist.innerHTML = Storage.history.map(h => `<div class="cart-history-item"><div class="time">${h.time}</div><div style="margin-top:2px;color:#ccc;">${h.items.join(', ')}</div></div>`).join('');
      },
      updateUI() { Cart.updateCount(); if (document.getElementById('cartBody').style.display === 'block') Cart.renderList(); },
      findItem(word) {
        for (const cat in Data.local) for (const group in Data.local[cat]) {
          const arr = Data.local[cat][group];
          if (Array.isArray(arr)) {
            const found = arr.find(w => (w.词 || w) === word);
            if (found) return found;
          }
        }
        return null;
      }
    };

    const Storage = {
      cart: JSON.parse(localStorage.getItem('nsfw-cart') || '[]'),
      history: JSON.parse(localStorage.getItem('nsfw-cart-history') || '[]'),
      copy: JSON.parse(localStorage.getItem('nsfw-copies') || '{}'),
      saveCart() { localStorage.setItem('nsfw-cart', JSON.stringify(this.cart)); },
      saveHistory() { localStorage.setItem('nsfw-cart-history', JSON.stringify(this.history)); },
      copyWord(word) {
        navigator.clipboard.writeText(word);
        this.copy[word] = (this.copy[word] || 0) + 1;
        localStorage.setItem('nsfw-copies', JSON.stringify(this.copy));
        Toast.show(`已复制: ${word}`);
      }
    };

    const DOM = {
      buildNav(node, parent, path = []) {
        if (!node || typeof node !== 'object' || Array.isArray(node)) return;
        Object.keys(node).forEach(key => {
          const li = document.createElement('li');
          const span = document.createElement('span');
          span.className = 'folder';
          span.innerHTML = `<i class="fas fa-folder"></i> ${key}`;
          span.onclick = () => UI.goTo([...path, key]);
          li.appendChild(span);
          const child = node[key];
          if (child && typeof child === 'object' && !Array.isArray(child)) {
            const ul = document.createElement('ul');
            ul.className = 'sub';
            li.appendChild(ul);
            DOM.buildNav(child, ul, [...path, key]);
          }
          parent.appendChild(li);
        });
      }
    };

    const Toast = {
      show(msg) { this.create(msg, 'success'); },
      error(msg) { this.create(msg, 'error'); },
      create(msg, type) {
        const t = document.createElement('div');
        t.className = `toast ${type === 'error' ? 'error' : ''}`;
        t.textContent = msg;
        document.body.appendChild(t);
        requestAnimationFrame(() => { t.style.opacity = 1; t.style.transform = 'translateX(0)'; });
        setTimeout(() => {
          t.style.opacity = 0; t.style.transform = 'translateX(100%)';
          t.addEventListener('transitionend', () => t.remove());
        }, 3000);
      }
    };

    // 初始化
    document.getElementById('btnSelectImg').onclick = () => document.getElementById('imgUpload').click();
    document.getElementById('imgUpload').onchange = e => {
      if (e.target.files[0]) document.getElementById('btnUploadImg').disabled = false;
    };
    document.getElementById('btnUploadImg').onclick = async () => {
      const file = document.getElementById('imgUpload').files[0];
      if (!file) return;
      const btn = document.getElementById('btnUploadImg');
      btn.disabled = true; btn.textContent = '上传中...';
      try {
        let API_KEY = localStorage.getItem('imgbb_api_key') || prompt('请输入 ImgBB API Key:');
        if (API_KEY) localStorage.setItem('imgbb_api_key', API_KEY);
        const form = new FormData(); form.append('image', file);
        const res = await fetch(`https://api.imgbb.com/1/upload?key=${API_KEY}`, { method: 'POST', body: form });
        const data = await res.json();
        if (data.success) {
          Cart.uploadedUrl = data.data.url;
          const medium = data.data.url.replace(/\/[^/]+$/, '/medium/$&');
          document.getElementById('imgPreview').innerHTML = `<img src="${medium}" style="max-height:140px;">`;
          btn.textContent = '已获取'; Toast.show('上传成功');
        } else throw new Error(data.error?.message || '上传失败');
      } catch (e) {
        Toast.error(e.message); btn.textContent = '重新上传'; btn.disabled = false;
      }
    };

    window.addEventListener('load', () => {
      Data.load();
      Cart.updateUI();
    });
  </script>
</body>
</html>
